# プロジェクト進捗記録

## プロジェクト情報

**プロジェクト名**: MOBA × 弾幕シューティングゲーム（仮称）
**開始日**: 2025-12-04
**現在のフェーズ**: プロジェクトセットアップ完了

---

## セッション履歴

### Session 1: 2025-12-04 - 要件定義

#### 実施内容
1. ゲームコンセプトのヒアリング
2. 詳細な要件の確認（20項目）
3. 要件定義書の作成 (`REQUIREMENTS.md`)

#### 決定事項

**ゲームの基本仕様**
- トップダウン視点
- シングルプレイヤー
- PCブラウザベース

**キャラクター・スキルシステム**
- 初期4キャラクター実装
- QWER: キャラクター固有スキル
- DF: プレイヤー選択スキル
- クールダウン制 + 通常攻撃（AA）

**HP・残機システム**
- 残機3機
- その場復活 + 2秒無敵
- 道中にHP回復アイテムあり

**ステージ構成**
- 全6ステージ
- 構成: 道中 → 中ボス → 道中 → ボス
- プレイヤー移動に応じたスクロール
- 後方が侵入不可エリアになる仕様
- 難易度選択: Easy/Normal/Hard

**敵・弾幕システム**
- 雑魚敵、中ボス、ボス
- 東方風の弾幕パターン
- 弾幕 + 体当たり + 範囲攻撃（LoL風）

**進行・報酬システム**
- スコア・ランク評価システム
- アイテムドロップ
- ステージクリア後のキャラクター強化

**技術スタック（提案）**
- エンジン: Phaser 3
- 言語: TypeScript
- ビルドツール: Vite
- 状態管理: Zustand

#### 成果物
- `REQUIREMENTS.md`: 完全な要件定義書（20セクション）

#### 次のステップ（提案）
1. プロジェクトセットアップ（Phaser 3 + TypeScript + Vite）
2. 基本的なゲームループの実装
3. プレイヤーキャラクターの移動システム実装
4. 通常攻撃（AA）の実装

---

### Session 2: 2025-12-04 - プロジェクトセットアップ

#### 実施内容
1. Docker環境の構築
2. Phaser 3 + TypeScript + Vite プロジェクトの初期化
3. 基本的なフォルダ構成の作成
4. 型定義ファイルの作成
5. ゲーム設定ファイルの作成
6. BootScene, GameScene の実装

#### 決定事項

**Docker環境**
- Docker Composeを使用した開発環境
- ホットリロード対応（usePolling有効）
- ポート: 3000
- Node.js 20 Alpine イメージを使用

**プロジェクト構成**
```
moba_touhou/
├── public/assets/        # ゲームアセット
├── src/
│   ├── config/          # ゲーム設定
│   ├── scenes/          # Phaserシーン
│   ├── entities/        # エンティティ
│   ├── systems/         # システム
│   ├── components/      # コンポーネント
│   ├── ui/              # UI
│   ├── utils/           # ユーティリティ
│   └── types/           # 型定義
├── Dockerfile
├── docker-compose.yml
└── vite.config.ts
```

**実装した機能**
- BootScene: アセット読み込みと仮スプライト生成
- GameScene: プレイエリア表示、デバッグ情報、ウェルカムメッセージ
- 型定義: ゲーム全体で使用する型（Position, CharacterType, SkillSlot等）
- ゲーム設定: 画面サイズ、プレイエリア、色定義、レイヤー深度等

#### 成果物
- `package.json` - プロジェクト設定
- `tsconfig.json` - TypeScript設定
- `vite.config.ts` - Vite設定（パスエイリアス含む）
- `Dockerfile` - Docker設定
- `docker-compose.yml` - Docker Compose設定
- `src/main.ts` - エントリーポイント
- `src/types/index.ts` - 型定義
- `src/config/GameConfig.ts` - ゲーム設定
- `src/scenes/BootScene.ts` - ブートシーン
- `src/scenes/GameScene.ts` - ゲームシーン
- `README.md` - プロジェクト概要
- `SETUP.md` - セットアップガイド
- `.gitignore` - Git除外設定
- `.dockerignore` - Docker除外設定

#### 次のステップ
1. Docker Desktopを起動してビルド＆起動確認
2. プレイヤーエンティティの実装
3. 右クリック移動システムの実装
4. 通常攻撃（AA）の実装

---

### Session 3: 2025-12-04 - プレイヤー実装・移動システム

#### 実施内容
1. キャラクターデータ定義の作成
2. Playerエンティティクラスの実装
3. InputManagerシステムの実装
4. 右クリック移動システムの実装
5. GameSceneへの統合

#### 実装した機能

**CharacterData.ts**
- 4キャラクター（霊夢、魔理沙、咲夜、妖夢）のステータス定義
- 各キャラクターのスキル設定（Q/W/E/R）

**Player.ts**
- Phaser.Physics.Arcade.Spriteを継承
- HP管理システム（ダメージ、回復、死亡処理）
- 移動システム（目標位置への移動）
- 無敵時間システム（復活時の点滅）
- 被弾エフェクト
- ゲッター（HP、キャラクター情報等）

**InputManager.ts**
- 右クリック移動の検出
- プレイエリア境界チェック
- 移動先マーカー表示（フェードアウトアニメーション）
- スキルキー（Q/W/E/R/D/F）のイベント設定
- コンテキストメニューの無効化

**GameScene.ts更新**
- プレイヤーの生成と配置
- InputManagerの初期化
- デバッグ情報の表示（キャラクター情報、位置、速度等）
- 操作説明の表示（5秒後フェードアウト）

#### 成果物
- `src/config/CharacterData.ts` - キャラクター定義
- `src/entities/Player.ts` - プレイヤークラス
- `src/systems/InputManager.ts` - 入力管理システム
- `src/scenes/GameScene.ts` - 更新（プレイヤー統合）

#### 技術的な実装ポイント

**移動システム**
- 目標位置への直線移動
- 到達判定（5px以内で停止）
- プレイエリア内のみ移動可能
- 移動速度はキャラクターステータスに依存

**当たり判定**
- 円形の当たり判定（hitboxRadius: 8px）
- Arcade Physicsを使用

**アニメーション**
- 被弾時の赤フラッシュ（100ms）
- 無敵時の点滅（2秒間）
- 移動先マーカーのフェードアウト

#### 次のステップ
1. Docker起動確認（実際にゲームを動かす）
2. 通常攻撃（AA）システムの実装
3. 弾のオブジェクトプーリング
4. 簡易的な敵の実装

---

### Session 4: 2025-12-04 - 通常攻撃システム・敵の実装

#### 実施内容
1. Bulletエンティティクラスの作成
2. ObjectPoolユーティリティの作成
3. Enemyエンティティクラスの作成
4. Playerに自動攻撃ロジックを追加
5. GameSceneで敵生成と衝突判定を設定

#### 実装した機能

**Bullet.ts**
- 弾エンティティ（プレイヤー弾・敵弾）
- fire()メソッドで発射
- 画面外判定で自動非アクティブ化
- ダメージ値、速度、弾種の管理

**ObjectPool.ts (BulletPool)**
- 弾のオブジェクトプーリング
- 初期50個、最大200個
- acquire()で弾を取得（再利用）
- 統計情報取得（アクティブ/非アクティブ数）

**Enemy.ts**
- 敵エンティティ（4種類: NORMAL, ELITE, MINI_BOSS, BOSS）
- 3種類の移動パターン（straight, wave, zigzag）
- HP管理、ダメージ処理
- スコア値の設定
- 被弾エフェクト（白フラッシュ）

**Player.ts（更新）**
- ~~自動攻撃ロジック~~ → Session 5で手動攻撃に変更
  - ~~最も近い敵を探索~~
  - ~~射程内の敵に自動攻撃~~
  - ~~攻撃速度に応じたクールダウン~~
- 弾プールと敵リストの管理

**GameScene.ts（更新）**
- 弾プールの初期化
- 敵プールの作成（20体）
- 2秒ごとに敵を自動生成
- 衝突判定の設定
  - プレイヤー弾 × 敵
  - プレイヤー × 敵
- スコアシステム
- デバッグ情報の拡充（弾数、敵数、スコア表示）

#### 成果物
- `src/entities/Bullet.ts` - 弾エンティティ
- `src/entities/Enemy.ts` - 敵エンティティ
- `src/utils/ObjectPool.ts` - 弾プール
- `src/entities/Player.ts` - 更新（自動攻撃）
- `src/scenes/GameScene.ts` - 更新（敵生成・衝突判定）

#### 技術的な実装ポイント

**オブジェクトプーリング**
- 弾を毎フレーム生成・破棄せず再利用
- パフォーマンス向上（GC負荷軽減）
- 最大数管理で暴走防止

**自動攻撃システム**
- 最近接敵探索アルゴリズム
- 射程チェック（300px）
- 攻撃速度制御（霊夢: 2回/秒）

**衝突判定**
- Phaser Arcade Physics のoverlap使用
- ダメージ計算とスコア加算
- 弾・敵の自動非アクティブ化

**敵の移動パターン**
- straight: 直線降下
- wave: sin波で左右移動
- zigzag: ジグザグ移動

#### 次のステップ
1. ~~攻撃システムの改善（LoL風の手動攻撃）~~ → Session 5で完了
2. 敵の弾幕システム（簡易版）
3. UIシステム（HPバー、スコア表示）
4. スキルシステムの実装
5. サウンドエフェクトの追加

---

### Session 5: 2025-12-04 - LoL風手動攻撃システムの実装

#### 実施内容
1. Player.tsから自動攻撃ロジックを削除
2. 手動攻撃システムの実装（attackTarget()メソッド）
3. Attack Move機能の実装（Aキー）
4. 射程範囲表示＆攻撃機能の実装（Sキー）
5. InputManagerに左クリック攻撃を追加
6. GameSceneの操作説明を更新

#### 実装した機能

**Player.ts（更新）**
- 自動攻撃ロジックを削除
- 手動攻撃メソッドの追加
  - `attackTarget()`: 指定した敵に攻撃（射程チェック付き）
  - `stopMovement()`: 移動を即座に停止
  - `setAttackMove()`: Attack Moveを設定
- Attack Move機能
  - `updateAttackMove()`: 移動中に射程内の敵を発見したら攻撃して停止
  - Aキー押下後のクリック位置に移動、敵発見で自動攻撃
- 敵探索メソッドの追加
  - `findNearestEnemy()`: プレイヤーから最も近い敵を探す（public化）
  - `findNearestEnemyToPosition()`: 指定位置から最も近い敵を探す

**InputManager.ts（大幅更新）**
- 左クリック攻撃の実装
  - `handleLeftClick()`: 左クリック時の処理
  - `getEnemyAtPosition()`: クリック位置の敵を取得（30px判定半径）
  - 敵をクリックすると即座に攻撃
- Aキー: Attack Move
  - `handleAttackMoveKey()`: Aキー押下後の次のクリックをAttack Moveとして処理
  - クリック位置に移動、敵発見で自動攻撃して停止
- Sキー: 射程範囲表示
  - `handleShowRangeKey()`: Sキー押下で射程範囲表示をトグル
  - `showAttackRange()`: 攻撃範囲の円を表示（半透明の塗りと線）
  - `hideAttackRange()`: 攻撃範囲を非表示
  - `attackNearestEnemyAt()`: Sキー状態で左クリックすると最も近い敵に攻撃
- 射程範囲の追従
  - update()でプレイヤーの位置に円を追従
- 敵リストの管理
  - `setEnemies()`: 敵リストを受け取る

**GameScene.ts（更新）**
- InputManagerに敵リストを渡す処理を追加
- 操作説明を更新
  - 右クリック: 移動
  - 左クリック: 敵を攻撃
  - A: Attack Move（移動+自動攻撃）
  - S: 射程範囲表示（左クリックで範囲攻撃）
  - Q/W/E/R: スキル（未実装）
  - D/F: プレイヤースキル（未実装）

#### 成果物
- `src/entities/Player.ts` - 手動攻撃システム実装
- `src/systems/InputManager.ts` - 左クリック、Aキー、Sキーの実装
- `src/scenes/GameScene.ts` - 敵リスト連携、操作説明更新

#### 技術的な実装ポイント

**LoL風攻撃システムの実装**
- 左クリック: 敵をクリックで1回攻撃
  - クリック位置から30px以内の敵を検出
  - 射程内かチェック後に攻撃
- Attack Move（Aキー）:
  1. Aキーを押す
  2. 移動先をクリック
  3. 移動開始
  4. 射程内に敵が入ったら即座に攻撃して停止
- 射程範囲表示（Sキー）:
  1. Sキーで射程範囲を表示（トグル）
  2. 円がプレイヤーに追従
  3. 左クリックでクリック位置から最も近い射程内の敵に攻撃

**UI/UX改善**
- 攻撃範囲表示: 半透明の円（塗り: 0.1, 線: 0.5）
- Attack Move時に移動マーカーを表示
- クリック判定の余裕（30px半径）

#### 変更内容のまとめ

**削除した機能**
- ❌ 自動攻撃ロジック（updateAutoAttack）
- ❌ 常時の最近接敵探索

**追加した機能**
- ✅ 左クリック攻撃（敵を直接クリック）
- ✅ Attack Move（Aキー + クリック）
- ✅ 射程範囲表示（Sキー）
- ✅ 射程範囲攻撃（Sキー状態で左クリック）

#### 次のステップ
1. 動作確認とテスト
2. 敵の弾幕システム（簡易版）
3. UIシステム（HPバー、スコア表示）
4. スキルシステムの実装

---

## 現在の状態

### 完了済み
- [x] 要件定義ヒアリング
- [x] 要件定義書作成
- [x] プロジェクトセットアップ
- [x] 開発環境構築（Docker）
- [x] 基本的なシーン実装
- [x] プレイヤーエンティティの実装
- [x] 右クリック移動システム
- [x] 入力管理システム
- [x] Docker環境での起動確認
- [x] 通常攻撃（AA）システム
- [x] 弾のオブジェクトプーリング
- [x] 簡易的な敵の実装
- [x] 衝突判定システム
- [x] スコアシステム
- [x] LoL風手動攻撃システム（左クリック、Aキー、Sキー）

### 未着手
- [ ] 敵の弾幕システム
- [x] UIシステム（HPバー、スコア表示）
- [ ] スキルシステム
- [ ] サウンドエフェクト

---

## ファイル構成

```
d:\repository\moba_touhou\
├── public/
│   └── assets/           # ゲームアセット（将来的に追加）
├── src/
│   ├── config/
│   │   ├── GameConfig.ts
│   │   └── CharacterData.ts
│   ├── scenes/
│   │   ├── BootScene.ts
│   │   └── GameScene.ts
│   ├── entities/
│   │   ├── Player.ts
│   │   ├── Enemy.ts
│   │   └── Bullet.ts
│   ├── systems/
│   │   └── InputManager.ts
│   ├── utils/
│   │   └── ObjectPool.ts
│   ├── types/
│   │   └── index.ts
│   ├── components/       # （未実装）
│   ├── ui/               # （未実装）
│   └── main.ts
├── Dockerfile
├── docker-compose.yml
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts
├── .gitignore
├── .dockerignore
├── REQUIREMENTS.md       # 要件定義書
├── PROJECT_LOG.md        # このファイル（進捗記録）
├── NEXT_STEPS.md         # 次のステップガイド
├── SETUP.md              # セットアップガイド
└── README.md             # プロジェクト概要
```

---

## 重要な設計決定

### 1. 技術選定理由
- **Phaser 3**: 2D特化、弾幕ゲームに最適、豊富なプラグイン
- **TypeScript**: 型安全性、大規模開発での保守性
- **Vite**: 高速なHMR、優れた開発体験

### 2. ゲームデザインのキーポイント
- **操作感**: LoL風の右クリック移動
- **弾幕**: 東方風のパターン弾幕
- **難易度**: 弾幕一発アウトではなく、HP制で初心者にも優しい
- **進行**: プレイヤー主導のスクロール、後方境界で前進を促す

### 3. スコープ管理
- **Phase 1 目標**: 1キャラクター、1ステージの動作するプロトタイプ
- **最小構成**: 基本移動 + AA + 4スキル + 簡易弾幕
- **段階的拡張**: プロトタイプ → 4キャラクター → 6ステージ

### 4. Docker環境の選択理由
- **一貫性**: 開発環境の統一、「私のマシンでは動く」問題の解消
- **隔離性**: プロジェクトごとの依存関係を分離
- **再現性**: セットアップ手順の簡素化
- **ホットリロード**: usePolling設定でWindows環境でも正常に動作

---

## 次のセッションで確認すべき事項

### 起動確認
- [ ] Docker Desktopを起動
- [ ] `docker-compose up --build` を実行
- [ ] ブラウザで http://localhost:3000 にアクセス
- [ ] ゲーム画面が正常に表示されることを確認

### プロトタイプの優先順位
1. プレイヤーエンティティの実装
2. 右クリック移動システム
3. 通常攻撃（AA）
4. 基本的なスキル1つ
5. 簡易的な敵と弾幕
6. 当たり判定・ダメージシステム

---

## 技術的検討事項

### パフォーマンス対策
- オブジェクトプーリング（弾、敵、エフェクト）
- 空間分割による衝突判定最適化（QuadTree）
- 画面外オブジェクトの非アクティブ化

### アーキテクチャ方針
- ECS（Entity Component System）パターンの検討
- データ駆動設計（キャラクター、スキル、敵の定義をJSON化）
- シーン管理（メニュー、ゲーム、リザルト等）

---

## 参考資料

### 技術ドキュメント
- Phaser 3 公式: https://phaser.io/
- Phaser 3 Examples: https://labs.phaser.io/
- TypeScript Handbook: https://www.typescriptlang.org/docs/

### ゲームデザイン参考
- League of Legends: 操作感、スキルシステム
- 東方Project: 弾幕パターン、ボス戦デザイン

---

## 備考・メモ

- 要件定義は完了、次は実装フェーズへ
- プロトタイプは最小限の機能で動作確認を優先
- アセット（画像・音声）は仮素材でスタート可能
- Git リポジトリ初期化は未実施（必要に応じて実施）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-04 | プロジェクト開始、要件定義完了 |
| 2025-12-04 | プロジェクトセットアップ完了（Docker + Phaser 3 + TypeScript + Vite） |
| 2025-12-04 | プレイヤー実装・右クリック移動システム完了 |
| 2025-12-04 | 通常攻撃（AA）・敵システム・衝突判定完了 |
| 2025-12-04 | LoL風手動攻撃システム実装（左クリック、Aキー、Sキー） |
| 2025-12-07 | UIシステム実装（スキルバー、HPバー、PlayerZone、EnemyZone） |

