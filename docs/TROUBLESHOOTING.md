# トラブルシューティング記録

このドキュメントは開発中に遭遇した問題とその解決策を記録しています。

---

## 2024年 - ルーミアEスキル移動時のスプライト方向バグ

### 問題の症状

ルーミアのEスキル（通常弾幕3）で移動する際、**稀に**左を向いたまま右方向に移動することがあった。
- 「左を向いたまま右に移動」のパターンのみ発生
- 「右を向いたまま左に移動」は発生しなかった
- 再現率が低く、原因特定に時間がかかった

### 原因

**角度の範囲の不一致**が原因だった。

1. `calculateSafeESkillDirection()`が`Math.random() * Math.PI * 2`で**0〜360度（0〜2π）**の角度を生成
2. FlipXの判定は`angleDeg > 90 || angleDeg < -90`で**-180〜180度**を前提としていた
3. 例：332度は右下方向（-28度と同等）だが、`332 > 90`でtrue判定 → FlipX=true（間違い）

```typescript
// 問題のあったコード
const angleDeg = Phaser.Math.RadToDeg(this.eSkillMoveDirection);
const shouldFlipX = angleDeg > 90 || angleDeg < -90;
// 332度 → 332 > 90 → true → 左向き（間違い！本当は右向きであるべき）
```

### 解決策

全ての角度判定箇所で、180度を超える角度を-180〜180度の範囲に正規化する処理を追加。

```typescript
// 修正後のコード
let angleDeg = Phaser.Math.RadToDeg(this.eSkillMoveDirection);
// 0〜360度を-180〜180度に正規化
if (angleDeg > 180) angleDeg -= 360;
const shouldFlipX = angleDeg > 90 || angleDeg < -90;
// 332度 → -28度 → -28 > 90 も -28 < -90 もfalse → 右向き（正しい！）
```

### 修正箇所

1. `updateMoveDirectionByAngle()` - 通常移動時のスプライト方向
2. `updateAnimation()`内のEスキル移動判定 - 毎フレームの方向チェック
3. `before_move` → `moving`遷移時 - 移動開始時のスプライト方向設定

### 教訓

- `Math.random() * Math.PI * 2`は0〜2π（0〜360度）を返す
- `Math.atan2()`は-π〜π（-180〜180度）を返す
- 角度を扱う際は、生成元と判定ロジックの範囲が一致しているか確認する
- 「稀に発生」「特定の方向のみ」といったパターンがある場合、境界値や範囲の問題を疑う

### デバッグのポイント

1. ログに角度とFlipXの値を出力して、期待値との差異を確認
2. 問題が「片方向のみ」発生する場合、条件判定の非対称性を疑う
3. ランダム値が関係する場合、その値の範囲を確認する

---

## テンプレート

### 問題の症状

（症状を記述）

### 原因

（原因を記述）

### 解決策

（解決策を記述）

### 修正箇所

（修正したファイル・行を記述）

### 教訓

（今後のために学んだことを記述）
